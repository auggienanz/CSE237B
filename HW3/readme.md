# CSE 237B Lab 3: Preemptive Earliest-Deadline-First (EDF) Scheduling

The goal of this lab is to implement an earliest deadline first (EDF) scheduler in Go. The scheduler shall have a configurable number of workers and should support preemption.

For the purposes of this lab, a `Task` is generated by an `App` with a given deadline and necessary computation time. 

Generated tasks are passed to the `Scheduler`. The Scheduler maintains a queue of tasks which must be run. Access to this queue is protected by a Go `sync.Mutex`. New tasks are added to the queue and the queue is then sorted by deadline, such that the first element is the task with the earliest deadline. If there is a free worker available (also kept in a pool protected by a `sync.Mutex`), the task is assigned to the free worker. If there are no workers available (and preemption is enabled), the scheduler checks the deadline of the newly arrived task against those running on other workers. If it finds a worker running a task which has a later deadline, the scheduler preempts the task by passing 0 to a `PreemptChan`. 

When a worker receives a new task with preemption disabled, it simply "processes" the task by sleeping the amount of time required by the task's `TotalRunTime` parameter. In the case of preemption, the process is as follows:

```go
for {
  select {
    case <-w.PreemptChan:
      // preempted
      break loop
    default:
      time.Sleep(c.CHECK_PREEMPT_INTERVAL)
      t.RunTime += c.CHECK_PREEMPT_INTERVAL
      if t.RunTime >= t.TotalRunTime {
        // Task is done
        break loop
    }
  }		
}
```

Thus, if the worker is preempted, it stops what it is doing and returns itself to the free worker pool. Otherwise, it processes a little more of its task until checking for preemption again.

When a worker is finished with its task, it signals, through a channel, to the scheduler that it is free. The scheduler must check to see if the worker's task completed: it may have been preeempted, in which case the task must be put back into the task queue. Next, the worker is assigned the next task in the task queue. If there are no tasks in the queue, the worker is added to the free worker queue in wait of a new task to be scheduled.

## Example Output

Below is an example output with preemption enabled:

```
2017/06/06 23:51:56 Worker<0>: Task processor starts
2017/06/06 23:51:56 Scheduler: Scheduling loop starts
2017/06/06 23:51:56 App<app1>: Task generator starts
2017/06/06 23:51:56 App<app0>: Task generator starts
2017/06/06 23:51:58 App<app1>: Create task<0>
2017/06/06 23:51:58 Scheduler: Received new task
2017/06/06 23:51:58 Worker <0>: App<app1>/Task<0> starts (ddl 2017-06-06 23:52:00.6988148 -0700 PDT)
2017/06/06 23:51:59 Worker <0>: App<app1>/Task<0> ends
2017/06/06 23:52:00 App<app0>: Create task<0>
2017/06/06 23:52:00 Scheduler: Received new task
2017/06/06 23:52:00 App<app1>: Create task<1>
2017/06/06 23:52:00 Scheduler: Received new task
2017/06/06 23:52:00 Worker <0>: App<app0>/Task<0> starts (ddl 2017-06-06 23:52:03.6996417 -0700 PDT)
2017/06/06 23:52:00 Worker <0>: App<app0>/Task<0> is preempted
2017/06/06 23:52:00 Worker <0>: App<app1>/Task<1> starts (ddl 2017-06-06 23:52:02.6996417 -0700 PDT)
2017/06/06 23:52:01 Worker <0>: App<app1>/Task<1> ends
2017/06/06 23:52:01 Worker <0>: App<app0>/Task<0> starts (ddl 2017-06-06 23:52:03.6996417 -0700 PDT)
2017/06/06 23:52:02 Worker <0>: App<app0>/Task<0> ends
2017/06/06 23:52:02 App<app1>: Create task<2>
2017/06/06 23:52:02 Scheduler: Received new task
2017/06/06 23:52:02 Worker <0>: App<app1>/Task<2> starts (ddl 2017-06-06 23:52:04.6994446 -0700 PDT)
2017/06/06 23:52:04 Worker <0>: App<app1>/Task<2> ends
2017/06/06 23:52:04 App<app0>: Create task<1>
2017/06/06 23:52:04 Scheduler: Received new task
2017/06/06 23:52:04 App<app1>: Create task<3>
2017/06/06 23:52:04 Scheduler: Received new task
2017/06/06 23:52:04 Worker <0>: App<app0>/Task<1> starts (ddl 2017-06-06 23:52:07.6988165 -0700 PDT)
2017/06/06 23:52:04 Worker <0>: App<app0>/Task<1> is preempted
2017/06/06 23:52:04 Worker <0>: App<app1>/Task<3> starts (ddl 2017-06-06 23:52:06.6988165 -0700 PDT)
2017/06/06 23:52:05 Worker <0>: App<app1>/Task<3> ends
2017/06/06 23:52:05 Worker <0>: App<app0>/Task<1> starts (ddl 2017-06-06 23:52:07.6988165 -0700 PDT)
2017/06/06 23:52:06 App<app1>: Create task<4>
2017/06/06 23:52:06 Scheduler: Received new task
2017/06/06 23:52:07 Worker <0>: App<app0>/Task<1> ends
2017/06/06 23:52:07 Worker <0>: App<app1>/Task<4> starts (ddl 2017-06-06 23:52:08.6994389 -0700 PDT)
2017/06/06 23:52:08 Worker <0>: App<app1>/Task<4> ends
2017/06/06 23:52:08 App<app0>: Create task<2>
2017/06/06 23:52:08 Scheduler: Received new task
2017/06/06 23:52:08 Worker <0>: App<app0>/Task<2> starts (ddl 2017-06-06 23:52:11.6987807 -0700 PDT)
2017/06/06 23:52:08 App<app1>: Create task<5>
2017/06/06 23:52:08 Scheduler: Received new task
2017/06/06 23:52:08 Worker <0>: App<app0>/Task<2> is preempted
2017/06/06 23:52:08 Worker <0>: App<app1>/Task<5> starts (ddl 2017-06-06 23:52:10.6987807 -0700 PDT)
2017/06/06 23:52:10 Worker <0>: App<app1>/Task<5> ends
2017/06/06 23:52:10 Worker <0>: App<app0>/Task<2> resumes
2017/06/06 23:52:10 App<app1>: Create task<6>
2017/06/06 23:52:10 Scheduler: Received new task
2017/06/06 23:52:10 Worker <0>: App<app0>/Task<2> ends
2017/06/06 23:52:10 Worker <0>: App<app1>/Task<6> starts (ddl 2017-06-06 23:52:12.6988181 -0700 PDT)
2017/06/06 23:52:12 Worker <0>: App<app1>/Task<6> ends
2017/06/06 23:52:12 App<app1>: Create task<7>
2017/06/06 23:52:12 Scheduler: Received new task
2017/06/06 23:52:12 App<app0>: Create task<3>
2017/06/06 23:52:12 Scheduler: Received new task
2017/06/06 23:52:12 Worker <0>: App<app1>/Task<7> starts (ddl 2017-06-06 23:52:14.6995074 -0700 PDT)
2017/06/06 23:52:14 Worker <0>: App<app1>/Task<7> ends
2017/06/06 23:52:14 Worker <0>: App<app0>/Task<3> starts (ddl 2017-06-06 23:52:15.6995074 -0700 PDT)
2017/06/06 23:52:14 App<app1>: Create task<8>
2017/06/06 23:52:14 Scheduler: Received new task
2017/06/06 23:52:15 Worker <0>: App<app0>/Task<3> ends
2017/06/06 23:52:15 Worker <0>: App<app1>/Task<8> starts (ddl 2017-06-06 23:52:16.6994639 -0700 PDT)
2017/06/06 23:52:16 App<app0>: Task generator ends
2017/06/06 23:52:16 App<app1>: Task generator ends
2017/06/06 23:52:16 Worker <0>: App<app1>/Task<8> ends
2017/06/06 23:52:16 Worker<0>: Task processor ends
```

